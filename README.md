# Как создать схему XML документа (XSD)
[видео на YouTube](https://youtu.be/Bf6ax20K5hw)

## Файл схемы

- Запустить программу [XmlPad](https://xmlpad-mobile.com/#WmHelp)
- Выполнить команду меню `File`/ `New ...`
- В группе `XML` выбрать `XSD Schema`
- Нажать кнопку `Ok`
- Появиться окно для ввода названия пространства имён схемы
- Пространство имён это произвольная строка, желательно придерживаться
подобного названия:
`urn://rpn.gov.ru/services/smev/nazvanie-vida-svedenii/1.0.0`
- Установить версию `1.0.0`

## Элемент для запроса

- В корень документа добавить элемент `Zapros`
- В элемент `Zapros` добавить аннотацию
- В аннотацию элемента `Zapros` добавить документацию
- Записать в документацию элемента `Zapros` описание элемента: "запрос 
сведений"
- Добавить комплексный тип `ZaprosType`
- Для элемента `Zapros` установить тип `ZaprosType`

## Элемент для ответа

- В корень документа добавить элемент `Otvet`
- В элемент `Otvet` добавить аннотацию
- В аннотацию элемента `Otvet` добавить документацию
- Записать в документацию элемента `Otvet` описание элемента: 
  "сведения по запросу"
- Добавить комплексный тип `OtvetType`
- Для элемента `Otvet` установить тип `OtvetType`

## Элемент для обязательных сведений атрибутивного состава

- В комплексный тип `ZaprosType` добавить последовательность
- В последовательность комплексного типа `ZaprosType` добавить элемент 
`Obyazatelnie`
- Добавить комплексный тип `ObyazatelnieType`
- Для элемента `Obyazatelnie` установить тип `ObyazatelnieType`
- В комплексный тип `ObyazatelnieType` добавить последовательность

## Описание элемента для обязательных сведений атрибутивного состава

- Добавить в комплексный тип `ObyazatelnieType` новый атрибут 
  `Attrib1`
- Для атрибута `Attrib1` установить свойство `use` в значение 
  `required`
- Для атрибута `Attrib1` установить свойство `type` в значение 
  `xs:string`

Способом аналогичным способу создания атрибута `Attrib1`, добавить в 
комплексный тип `ObyazatelnieType` все обязательные
атрибуты из атрибутивного состава

Для всех обязательных атрибутов установить свойство `use` в значение 
`required`

## Элемент для необязательных сведений атрибутивного состава

- В последовательность комплексного типа `ZaprosType` добавить элемент 
`Neobyazatelnie`
- Для элемента `Neobyazatelnie` установить minOccurs равным `0`
- Добавить комплексный тип `NeobyazatelnieType`
- Для элемента `Neobyazatelnie` установить тип `NeobyazatelnieType`
- В комплексный тип `NeobyazatelnieType` добавить последовательность
- Добавить в комплексный тип `NeobyazatelnieType` новый атрибут
  `Attrib2`
- Для атрибута `Attrib2` установить свойство type в значение
  `xs:string`

Способом аналогичным способу создания атрибута `Attrib2` добавить в 
комплексный тип `NeobyazatelnieType` все необязательные атрибуты из 
атрибутивного состава

Для всех атрибутов установить свойство type в значение `xs:string`

## Описание обязательного множественного поля из атрибутивного состава

- В последовательность комплексного типа `ObyazatelnieType` добавить 
элемент `MnojestvennieZnacheniya`
- Добавить комплексный тип `MnojestvennieZnacheniyaType`
- Для элемента `MnojestvennieZnacheniya` установить тип 
`MnojestvennieZnacheniyaType`
- В комплексный тип `MnojestvennieZnacheniyaType` добавить 
последовательность
- В последовательность комплексного типа `MnojestvennieZnacheniyaType` 
добавить элемент `Mnojestvennoe`
- Добавить комплексный тип `MnojestvennoeType`
- Для элемента `Mnojestvennoe` установить тип `MnojestvennoeType`
- Для элемента `Mnojestvennoe` установить maxOccurs равным `unbounded`
- Добавить в комплексный тип `MnojestvennoeType` атрибуты, для 
обязательных установить свойство `use` в значение `required`, для всех 
атрибутов установить свойство `type` в значение `xs:string`

Способом аналогичным способу создания элемента
`MnojestvennieZnacheniya` добавить в комплексный тип
`ObyazatelnieType` все обязательные множественные наборы атрибутов из
атрибутивного состава

## Описание необязательного множественного поля из атрибутивного состава

- В последовательность комплексного типа `NeobyazatelnieType` добавить 
элемент `MnogoZnachenii`
- Для элемента `MnogoZnachenii` установить `minOccurs` равным `0`
- Добавить комплексный тип `MnogoZnacheniiType`
- Для элемента `MnogoZnachenii` установить тип `MnogoZnacheniiType`
- В комплексный тип `MnogoZnacheniiType` добавить последовательность
- В последовательность комплексного типа `MnogoZnacheniiType` добавить 
элемент `Znachenie`
- Для элемента `Znachenie` установить `maxOccurs` равным `unbounded`
- Добавить комплексный тип `ZnachenieType`
- Для элемента `Znachenie` установить тип `ZnachenieType`
- Добавить в комплексный тип `ZnachenieType` атрибуты, для
  обязательных установить свойство `use` в значение `required`,
  установить свойство `type` в значение `xs:string`

Способом аналогичным способу создания элемента `MnogoZnachenii`
в комплексный тип `NeobyazatelnieType` добавить все необязательные
множественные наборы атрибутов из атрибутивного состава

Аналогично элементу `Zapros` описать атрибуты элемента `Otvet`
(`OtvetType`)

При разработке элемента `Otvet`, надо учесть вариант использования,
когда по запросу сведений, документ не был найден.

Для этого делаем элемент для массива найденных документов.

Массив найденных документов, это множественный элемент,
у которого в общем случае будут следующие значения атрибутов:
`minOccurs="0" maxOccurs="unbounded"`.

Пример XML документа когда сведений не найдено:
```xml
<Otvet><NaidennieSvedeniya vsego=0></NaidennieSvedeniya></Otvet>
```

Конечно, если сведений не найденно, можно отправить стандартный
ответ NO_DATA:
```xml
<ResponseContent>
    <rejects>
        <code>NO_DATA</code>
        <description>Сведения отсутствуют</description>
    </rejects>
</ResponseContent>
```

Но при разработке для ЕПГУ вам придётся ответить в формате ЕПГУ,
поэтому у вас должна быть возможность ответить с пустым списком
найденных документов.

При этом вариант использования, когда документы найдены, ответ
может выглядеть примерно так:
```xml
<Otvet>
  <NaidennieSvedeniya vsego=2>
    <Doc number=1 date="01.01.2001" inn="1234567890"/>
    <Doc number=2 date="01.01.1901" inn="1234567890"/>
  </NaidennieSvedeniya>
</Otvet>
```

Если разработка делается не для ЕПГУ, то очень важно в элементе
`Zapros`, предусмотреть атрибут для уникального идентификатора
входящего сообщения, и в элементе `Otvet` должен быть атрибут
для указания этого уникального идентификатора, это существенно
облегчает и отладку и тех поддержку по предоставлению сведений.

```xml
<Zapros id="Q_123">
  <SearchParameters inn="1234567890"/>
</Zapros>
```
```xml
<Otvet id="Q_123">
  <NaidennieSvedeniya vsego=2>
    <Doc number=1 date="01.01.2001" inn="1234567890"/>
    <Doc number=2 date="01.01.1901" inn="1234567890"/>
  </NaidennieSvedeniya>
</Otvet>
```

Имея уникальный идентификатор запроса `Q_123` вам будет проще найти
связанные сообщения как в БД адаптера, так и в файловой системе
адаптера - в файлах в папке `messages`.

Имена всех элементов и типов приведены для наглядности, в разработке
следует использовать английские названия из предметной области вида
сведений.

# Как выполнить проверку корректности схемы

- Выбрать вкладку с файлом
- Выполнить команду меню `XSD`\ `Validate`
- Должно появиться окно с сообщением об успехе проверки
- Если окна не появилось, то ошибки можно посмотреть в `Task List`
- Если такой области в интерфейсе нет, то её можно включить через
`View`\ `Task List`

# Как сгенерировать пример XML документа по XSD

- Выбрать вкладку с файлом
- Выполнить команду меню `XSD`\ `Generate sample XML file`
- В выпадающем списке `RootTag` выбрать элемент для которого хотим
создать образец заполнения (`Zapros` или `Otvet`)
- В поле `Recursion deep` установить значение `1`
- Нажать кнопку `Ok`
- Откроется вклад с файлом

Если сгенерированный файл не подходит, по каким то причинам, то можно
повторить всю процедуру, но увеличить на единицу значение в поле
`Recursion deep`, может понадобиться более 10-ти попыток генерации,
это нормально.

# Как разработать XSD Вида Сведений для ЕПГУ

[видео на YouTube](https://youtu.be/lMXLLRSoFcY)

## Почитать документацию

- Ознакомиться с `Требования к XML-схемам, регистрируемым в СМЭВ`
- Требования можно найти на сайте
  [Технологический портала](https://smev3.gosuslugi.ru/portal/) =>
  Для Разработчиков =>
  **Требования к XML-схемам, регистрируемым в СМЭВ 3**
- Ознакомиться с `Типовые технические требования к разработке ИФ
  заявлений на предоставление государственных и муниципальных услуг
  (функций)`, обратить внимание на
    - `пример вида сведений`
    - `фрагмента xsd-схемы для описания вложений`
    - `фрагмента xsd-схемы для адреса с полной детализацией элементов`
    - `Типы данных СМЭВ`
- Требования ЕПГУ можно получить на
  [Технологическом портале](https://smev3.gosuslugi.ru/portal/), но
  на дату 16.10.2021 самые актуальные требования выложены на сайте  
  [Кабинет государственного служащего](http://techportal.gosuslugi.ru/office-employee-gui/)
  => Информационно-справочный раздел => Документы для ОИВ =>
  Технические требования к разработке интерактивных форм заявлений =>
  [ссылка](http://oewp.gosuslugi.ru/static/0/0/0/0/0/0/0/0/0/1361_17_Tipovyetrebovaniyadlyarazrabotkiinteraktivnyhform.doc)
  версия 2.3 от 06.05.2021

## Сделать копию шаблона

- Сделать копию файла `epgu-basis.xsd` и директории с дополнительными 
  схемами `common`
- Переименовать файл схемы в соответствии с видом сведений
- Изменить `targetNamespace` и пространство имён по умолчанию 
  (`xmlns=`) на пространство имён нового вида сведений

## Описать типы (создать элементы и атрибуты из атрибутивного состава)

- Добавить способы получения услуги в `ServingType`
- Определиться с составом информации об исполнителе со стороны
  заявителя, описать в `CommunicationType`
- Определиться с составом информации о заявителе, описать в
  `AddresserType` (отправитель заявления), `NaturalPersonType`
  (физическое лицо), `SoleProprietorType` (индивидуальный
  предприниматель), `LegalEntityType` (юридическое лицо), 
  `ForeignerType` (лицо нерезидент РФ)
- Добавить описание типов: `MatterType` (суть заявления), 
  `InformationType` (сведения), `SearchType` (параметры поиска),
  `FoundType` (найденные документы)

# Как разработать новый ВС с целью выдачи сведений (что бы направлять ответы)

## Разработать XSD, эталонные запросы и ответы

- Проанализировать атрибутивный состав, требования к параметрам,
  сгруппировать параметры по смыслу передаваемой информации
- На основании группировки и требований к параметрам разработать XSD
  ([видео о разработке XSD](https://www.youtube.com/watch?v=Bf6ax20K5hw))
- XSD должна соответствовать требованиям МинКомСвязи
  ([Технологический портала](https://smev3.gosuslugi.ru/portal/) =>
  Для Разработчиков =>
  **Требования к XML-схемам, регистрируемым в СМЭВ 3**)
- Если вид сведений разрабатывается для ЕПГУ, то требования ЕПГУ можно
  получить на
  [Технологическом портале](https://smev3.gosuslugi.ru/portal/), но
  на дату 16.10.2021 самые актуальные требования выложены на сайте  
  [Кабинет государственного служащего](http://techportal.gosuslugi.ru/office-employee-gui/)
  => Информационно-справочный раздел => Документы для ОИВ =>
  Технические требования к разработке интерактивных форм заявлений =>
  [ссылка](http://oewp.gosuslugi.ru/static/0/0/0/0/0/0/0/0/0/1361_17_Tipovyetrebovaniyadlyarazrabotkiinteraktivnyhform.doc)
  версия 2.3 от 06.05.2021
- При разработке XSD на вид сведений следует использовать типы
  описанные в supplementary-commons-1.0.1.xsd
  (содержимое файла приведено в "Технические требования к разработке
  интерактивных форм заявлений")
- Разработать эталонные входящие и исходящие сообщения покрывающие все
  этапы и варианты бизнес процесса предоставления сведений

Этапы и варианты бизнес процесса разрабатывает бизнес аналитик

Бизнес аналитик разрабатывает XSD схему и эталонные сообщения, как
это делается описано в видео
[разработка XSD](https://www.youtube.com/watch?v=Bf6ax20K5hw)
